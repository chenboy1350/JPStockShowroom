<div class="container-fluid">
    <div class="row">
        <div class="card">
            <div class="card-body">
                <div class="accordion" id="accordionFilter">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFilter">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                                <strong>ตัวกรองการค้นหา</strong>
                            </button>
                        </h2>
                        <div id="collapseFilter" class="accordion-collapse collapse" aria-labelledby="headingFilter" data-bs-parent="#accordionFilter">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Article</label>
                                            <input type="text" id="txtArticleSearch" class="form-control" placeholder="กรอก Article" oninput="filterArticlePanel()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>ประเภทสินค้า (EDesArt)</label>
                                            <select id="ddlEDesArt" class="form-control" onchange="onFilterDDLChange()">
                                                <option value="">-- ทั้งหมด --</option>
                                                <option value="RING">RING</option>
                                                <option value="EARRING">EARRING</option>
                                                <option value="PENDANT">PENDANT</option>
                                                <option value="NECKLACE">NECKLACE</option>
                                                <option value="BRACELET">BRACELET</option>
                                                <option value="STUD">PIERCING</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>ประเภทงาน (Unit)</label>
                                            <select id="ddlUnit" class="form-control" onchange="onFilterDDLChange()">
                                                <option value="">-- ทั้งหมด --</option>
                                                <option value="PR">PR</option>
                                                <option value="PC">PC</option>
                                                <option value="SET">SET</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" onclick="clearArticleFilter()">Clear</button>
                                <button class="btn btn-primary" onclick="findStock()">ค้นหา</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-2" id="col-article" style="transition: all 0.3s ease; overflow: hidden;">
            <div class="card d-flex flex-column" >
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="card-title flex-grow-1">รายการสินค้า</h3>
                        <button class="btn btn-outline-secondary btn-sm ml-1" onclick="toggleArticlePanel()" title="ซ่อน">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-1" style="overflow-y: auto; height:75vh;">
                    <div id="article-list" class="d-flex flex-column gap-1">
                        @{
                            var articles = ViewBag.Articles as List<string> ?? new List<string>();
                        }
                        <button class="btn btn-sm w-100 text-start article-btn btn-primary"
                                onclick="selectArticle(null)">
                            <i class="fas fa-th-list me-1"></i> ทั้งหมด
                        </button>
                        @foreach (var a in articles)
                        {
                            <button class="btn btn-sm w-100 text-start article-btn btn-outline-secondary"
                                    data-article="@a"
                                    onclick="selectArticle('@Html.Raw(a.Replace("'", "\\'"))')" title="@a">
                                <i class="fas fa-tag me-1"></i> @a
                            </button>
                        }
                        @if (!articles.Any())
                        {
                            <div class="text-center text-muted small p-2">ไม่พบ Article</div>
                        }
                    </div>
                </div>
            </div>
        </div>


        <div class="col-lg-7" id="col-stock" style="transition: all 0.3s ease; overflow: hidden;">
            <div class="card d-flex flex-column" >
                <div class="card-header p-0 pt-2 px-2 d-flex align-items-center">
                    <button class="btn btn-primary btn-sm mr-2 shadow-sm d-none" id="btnShowArticle" onclick="toggleArticlePanel()" title="แสดง Article">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <ul class="nav nav-tabs flex-grow-1" id="stockTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="tab-stock-general" data-toggle="tab" href="#" role="tab"
                               onclick="switchStockTab('general')">
                                <i class="fas fa-boxes me-1"></i> สินค้าทั่วไป
                                <span class="badge badge-primary ml-1" id="badge-stock-general">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-stock-pending" data-toggle="tab" href="#" role="tab"
                               onclick="switchStockTab('pending')">
                                <i class="fas fa-clock me-1"></i> รอลงทะเบียน
                                <span class="badge badge-warning ml-1" id="badge-stock-pending">0</span>
                            </a>
                        </li>
                    </ul>
                    <button class="btn btn-primary btn-sm ml-2 shadow-sm d-none" id="btnShowTray" onclick="toggleTrayPanel()" title="แสดง Tray">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="card-body table-responsive" style="flex: 1 1 auto; overflow-y: auto; padding: 0px !important; height:75vh;">
                    <table id="tbl-stock" class="table table-head-fixed text-nowrap table-packed-custom" style="overflow: auto !important;">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th class="text-center">Article</th>
                                <th class="text-center">OrderNo</th>
                                <th class="text-center">EDesFn</th>
                                <th class="text-center">ListGem</th>
                                <th class="text-center">Date</th>
                                <th class="text-end">จำนวน</th>
                                <th class="text-center">สถานะ</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbl-stock-body">
                            <tr>
                                <td colspan="9" class="text-center text-muted">กดค้นหาเพื่อแสดงข้อมูล</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-3" id="col-tray" style="transition: all 0.3s ease; overflow: hidden;">
            <div class="card d-flex flex-column" >
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button class="btn btn-outline-secondary btn-sm mr-2" onclick="toggleTrayPanel()" title="ซ่อน">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <h3 class="card-title flex-grow-1">รายการถาด</h3>
                        <button class="btn btn-success btn-sm" onclick="showCreateTrayModal()">
                            <i class="fas fa-plus"></i> สร้างถาดใหม่
                        </button>
                    </div>
                </div>
                <div class="card-body table-responsive" style="flex: 1 1 auto; overflow-y: auto; padding: 0px !important; height:75vh;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom">
                        <thead>
                            <tr>
                                <th>เลขถาด</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-tray-body">
                            <tr>
                                <td colspan="2" class="text-center text-muted">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="modal-add-to-tray">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleAddToTray"><i class="fas fa-inbox"></i> เลือกสินค้าลงถาด :</h4>
                <input type="hidden" id="hddTrayId" value="" />
                <button type="button" class="close" onclick="$('#modal-add-to-tray').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body table-responsive" style="height:65vh; padding: 0px !important;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom" style="overflow: auto !important;">
                        <thead>
                            <tr>
                                <th style="width: 100px;">#</th>
                                <th>Article</th>
                                <th>OrderNo</th>
                                <th class="text-center">EDesFn</th>
                                <th class="text-center">ListGem</th>
                                <th class="text-end">จำนวน</th>
                                <th class="text-center">
                                    <div class="chk-wrapper">
                                        <input type="checkbox" id="chkTraySelectAll" class="custom-checkbox" checked>
                                        <label for="chkTraySelectAll" class="ms-2 mb-0">เลือก</label>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tbl-add-tray-body">
                            <tr>
                                <td colspan="10" class="text-center text-muted">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-success" id="btnAddToTray"><i class="fas fa-inbox"></i> ลงถาดรายการที่เลือก</button>
                <button type="button" class="btn btn-default" onclick="$('#modal-add-to-tray').modal('hide')">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-select-tray">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><i class="fas fa-inbox"></i> เลือกถาดลงสินค้า</h4>
                <button type="button" class="close" onclick="$('#modal-select-tray').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hddReverseStockId" />
                <div class="row mb-2">
                    <div class="col-md-12">
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtReverseSearchTray" placeholder="ค้นหาถาด (TrayNo / Description)...">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="loadReverseTrayList()">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-success" type="button" onclick="$('#modal-create-tray').modal('show')" title="สร้างถาดใหม่">
                                    <i class="fas fa-plus"></i> สร้างถาดใหม่
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body table-responsive" style="height:50vh; padding: 0px !important;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>TrayNo</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Article</th>
                            </tr>
                        </thead>
                        <tbody id="tbl-reverse-tray-list">
                        </tbody>
                    </table>
                </div>

                <div class="form-group mt-3">
                    <label>จำนวนที่จะลงถาด:</label>
                    <input type="number" id="txtReverseQty" class="form-control" min="0" step="0.5" />
                    <small class="text-muted">Available: <span id="lblReverseAvailableQty"></span></small>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                 <button type="button" class="btn btn-default" onclick="$('#modal-select-tray').modal('hide')">ยกเลิก</button>
                 <button type="button" class="btn btn-success" onclick="confirmAddToTrayReverse()">บันทึก</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-create-tray">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><i class="fas fa-plus-circle"></i> สร้างถาดใหม่</h4>
                <button type="button" class="close" onclick="$('#modal-create-tray').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label>เลขถาด <span class="text-danger">*</span></label>
                    <input type="text" id="txtNewTrayNo" class="form-control" placeholder="เช่น T001">
                </div>
                <div class="form-group">
                    <label>หมายเหตุ</label>
                    <input type="text" id="txtNewTrayDesc" class="form-control" placeholder="หมายเหตุ (ไม่บังคับ)">
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-success" id="btnCreateTray">สร้างถาด</button>
                <button type="button" class="btn btn-default" onclick="$('#modal-create-tray').modal('hide')">ปิด</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-tray-detail">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleTrayDetail"><i class="fas fa-box-open"></i> รายการในถาด :</h4>
                <input type="hidden" id="hddDetailTrayId" value="" />
                <button type="button" class="close" onclick="$('#modal-tray-detail').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body table-responsive" style="height:65vh; padding: 0px !important;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom" style="overflow: auto !important;">
                        <thead>
                            <tr>
                                <th style="width: 100px;">#</th>
                                <th>Article</th>
                                <th>OrderNo</th>
                                <th class="text-center">EDesFn</th>
                                <th class="text-center">ListGem</th>
                                <th class="text-end">จำนวน</th>
                                <th class="text-center">สถานะ</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-tray-detail-body">
                            <tr>
                                <td colspan="11" class="text-center text-muted">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <span class="text-muted" id="txtTrayDetailSummary"></span>
                </div>
                <button type="button" class="btn btn-default" onclick="$('#modal-tray-detail').modal('hide')">ปิด</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-borrow-list">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleBorrowList"><i class="fas fa-hand-holding"></i> รายการที่ยืม</h4>
                <button type="button" class="close" onclick="$('#modal-borrow-list').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body table-responsive" style="height:50vh; padding: 0px !important;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="text-center">Article</th>
                                <th>รายละเอียด</th>
                                <th class="text-center">เพชร/พลอย</th>
                                <th class="text-center">ถาด</th>
                                <th class="text-end">จำนวน</th>
                                <th>วันที่ยืม</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-borrow-body">
                            <tr>
                                <td colspan="9" class="text-center text-muted">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-default" onclick="$('#modal-borrow-list').modal('hide')">ปิด</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-withdrawal-history">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><i class="fas fa-file-export"></i> ประวัติการเบิกออก (ไม่คืน)</h4>
                <button type="button" class="close" onclick="$('#modal-withdrawal-history').modal('hide')" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body table-responsive" style="height:65vh; padding: 0px !important;">
                    <table class="table table-head-fixed text-nowrap table-packed-custom" style="overflow: auto !important;">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th>รหัสลูกค้า</th>
                                <th>OrderNo</th>
                                <th>LotNo</th>
                                <th class="text-center">ลำดับ</th>
                                <th>Barcode</th>
                                <th>Article</th>
                                <th class="text-end">จำนวน</th>
                                <th class="text-end">น้ำหนัก(g)</th>
                                <th>หมายเหตุ</th>
                                <th>วันที่เบิก</th>
                            </tr>
                        </thead>
                        <tbody id="tbl-withdrawal-body">
                            <tr>
                                <td colspan="11" class="text-center text-muted">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <span class="text-muted" id="txtWithdrawalSummary"></span>
                </div>
                <button type="button" class="btn btn-default" onclick="$('#modal-withdrawal-history').modal('hide')">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div id="page-title" data-title="จัดการ Stock"></div>

<script>

    @{
        var articleList = ViewBag.Articles as List<string> ?? new List<string>();
        var articlesJson = System.Text.Json.JsonSerializer.Serialize(articleList);
    }
    if (typeof _allArticles !== 'undefined') {
        _allArticles = @Html.Raw(articlesJson);
    }

    if (typeof findStock === 'function') findStock();
    if (typeof loadTrayList === 'function') loadTrayList();
</script>
